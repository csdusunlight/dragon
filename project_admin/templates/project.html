{% extends "base.html" %} {%load staticfiles%} {% block js %}
<script type="text/javascript" src="{%static 'js/ajaxfileupload.js'%}"></script>
<script type="text/javascript">

	var data = '<table width="100%"><tr><th>立项日期</th><th>项目编号</th><th>项目名称</th>' +
		'<th>商务对接人</th><th>合作方式</th><th>结算方式</th><th>签约公司</th><th>结算详情</th><th>项目状态</th>' +
		'<th>操作</th></tr>[data]<tr id="parent{id}"><td>{invest_time}</td><td>{usertype}</td><td>{mobile}</td>' +
		'<td>{project}</td><td>{invest_time}</td><td>{mobile_sub}</td><td>{invest_amount}</td><td>{term}</td>' +
		'<td>{state}</td>' +
		'<td id="item_{id}"><a class="revise-btn" onclick="pass({id})">修改' +
		'</a> │ <a class="delete-btn" onclick="refuse({id})">删除</a></td></tr>[/data]</table>';
	var url = "/project/projects" + "?page={page}&size={pageSize}";
	
	var project_id;		// project_id = -1 时，为导入单条数据；project_id != -1 时，为修改单条数据
	
	function pass(id) {			//弹出修改单条数据弹窗
		$(".popup-title").text("修改项目数据");
		$("#create_time_change")[0].type = "text";
		$("input#project_change_id").val(id);
		project_id = id;
		
		var parent = "parent" + id;
		var dom = document.getElementById(parent);
		var children0 = $(dom).find("td").eq(0).text(),
			children1 = $(dom).find("td").eq(1).text(),
			children2 = $(dom).find("td").eq(2).text(),
			children3 = $(dom).find("td").eq(3).text(),
			children4 = $(dom).find("td").eq(4).text(),
			children5 = $(dom).find("td").eq(5).text(),
			children6 = $(dom).find("td").eq(6).text(),
			children7 = $(dom).find("td").eq(7).text();
			
		var	children8 = $(dom).find("td").eq(8).text(),
			children8_num; 
			switch (children8)
			{
				case "全部":
					children8_num = 0;
					break;
				case "正在进行":
					children8_num = 1;
					break;
				case "暂停":
					children8_num = 2;
					break;
				case "已结束":
					children8_num = 3;
					break;
			}
		$("#create_time_change").val(children0);
		$("#project_num_change").val(children1);
		$("#project_name_change").val(children2);
		$("#contact_person_change").val(children3);
		$("#cooperate_type_change").val(children4);
		$("#balance_type_change").val(children5);
		$("#sign_company_change").val(children6);
		$("#balance_change").val(children7);
		$("#project_status_change").val(children8_num);
		
		$(".change-project").show();
	}
	
	function refuse(id) {		//弹出删除项目数据弹窗
		$("input#project_delete_id").val(id);
		$(".delete-project").show();
	}
	
	
	$(document).ready(function() {
		$("li.home15").addClass("show-project").toggleClass("on");
		$("li.home16").toggleClass("show");
		$(".Tin-table tr:even").css("background-color", "#fcfcfc");
		
		var choose_file = document.getElementById("input_clone");
		var hint = document.getElementById("hint");
		choose_file.onclick = function() {
			document.getElementById("fileupload1").click();
		}
		
		$("#pagedata").ajaxPage({
			url: url + "&state=1",
			pageId: $("#page"),
			pageSize: 5,
			run: true,
			content: data,
		});
		
		$("#single_import").click(function(){			//弹出单条导入弹窗
			$(".Finnow p input, .Finnow p select").val("");
			$("#project_status_change").val(0);
			$("#create_time_change")[0].type = "datetime-local";
			$(".popup-title").text("单条数据导入");
			$(".change-project").show();
			project_id = -1;
		})
		
		$(".none-x, .none-x-s").click(function() {		// 关闭或取消 弹窗
			$(".project-box").hide(); 
		})
		
		$('#change_project_btn').click(function() {		//点击确认按钮提交或修改单条项目数据
			var create_time_change = $("#create_time_change").val(),
				project_num_change = $("#project_num_change").val(),
				project_name_change = $("#project_name_change").val(),
				contact_person_change = $("#contact_person_change").val(),
				cooperate_type_change = $("#cooperate_type_change").val(),
				balance_type_change = $("#balance_type_change").val(),
				sign_company_change = $("#sign_company_change").val(),
				balance_change = $("#balance_change").val(),
				project_status_change = $("#project_status_change").val();
			
			console.log(project_id+", "+create_time_change+", "+project_num_change+", "+project_name_change+", "+contact_person_change+", "+cooperate_type_change+", "+balance_type_change+", "+sign_company_change+", "+balance_change+", "+project_status_change);
			
			$.ajax({
				url: "/project/projects/",
				dataType: "json",
				type: "POST",
				data: {
					'id': project_id,
					'create_time_change': create_time_change,
					'project_num_change': project_num_change,
					'project_name_change': project_name_change,
					'contact_person_change': contact_person_change,
					'contact_person_change': cooperate_type_change,
					'contact_person_change': balance_type_change,
					'contact_person_change': sign_company_change,
					'contact_person_change': balance_change,
					'project_status_change': project_status_change
				},
				success: function(ret) {
					if(ret.code == 0) {
						alert("操作成功！");
					} else if(ret.code == -1) {
						alert("该页面已过期，请重新登录！");
						window.location.href = ret.url;
					} else {
						alert(ret.res_msg);
					}
				},
				error: function() {
					alert("请检查网络连接");
				}
			});
			$(".change-project").hide();
		});
		
		$('#delete_project_btn').click(function() {		//点击确认按钮删除单条项目数据
			project_id = $("input#project_delete_id").val();
			console.log(project_id);
			
			$.ajax({
				url: "{%url 'admin_finance' %}",
				dataType: "json",
				type: "POST",
				data: {
					'id': project_id,
				},
				success: function(ret) {
					if(ret.code == 0) {
						alert("删除成功！");
					} else if(ret.code == -1) {
						alert("该页面已过期，请重新登录！");
						window.location.href = ret.url;
					} else {
						alert(ret.res_msg);
					}
				},
				error: function() {
					alert("请检查网络连接");
				}
			});
			$(".delete-project").hide();
		});
		
		$("#search").click(function() {			//搜索项目数据
			var newurl = url;
			
			created_time = $("#created_time").val();
			project_name = $("#project_name").val();
			contact_person = $("#contact_person").val();
			project_num = $("#project_num").val();
			cooperate_type = $("#cooperate_type").val();
			balance_type = $("#balance_type").val();
			sign_company = $("#sign_company").val();
			project_status = $("#project_status").val();
			
			if(created_time) {
				newurl += "&created_time=" + created_time;
			}
			if(project_name) {
				newurl += "&project_name=" + project_name;
			}
			if(contact_person) {
				newurl += "&contact_person=" + contact_person;
			}
			if(project_num) {
				newurl += "&project_num=" + project_num;
			}
			if(cooperate_type) {
				newurl += "&cooperate_type=" + cooperate_type;
			}
			if(balance_type) {
				newurl += "&balance_type=" + balance_type;
			}
			if(sign_company) {
				newurl += "&sign_company=" + sign_company;
			}
	//		if(project_status) {
	//			newurl += "&project_status=" + project_status;
	//		}
			console.log(newurl);
			
			var newdata = data;
			alert(newurl);
			$("#page").empty();
			$("#pagedata").ajaxPage({
				url: newurl,
				pageId: $("#page"),
				pageSize: 10,
				run: true,
				content: newdata,
			});
		});
		
		$("#export").click(function() {			//导出表格
			created_time = $("#created_time").val();
			project_name = $("#project_name").val();
			contact_person = $("#contact_person").val();
			project_num = $("#project_num").val();
			cooperate_type = $("#cooperate_type").val();
			balance_type = $("#balance_type").val();
			sign_company = $("#sign_company").val();
			project_status = $("#project_status").val();
			
			var html = '<form action="' + "{% url 'export_finance_excel' %}" + '" method="get" target="_self" id="postData_form">';
			
			if(created_time) {
				html += '<input name="created_time" type="hidden" value="' + created_time + '"/>';
			}
			
			if(project_name) {
				html += '<input name="project_name" type="hidden" value="' + project_name + '"/>';
			}
			
			if(contact_person) {
				html += '<input name="contact_person" type="hidden" value="' + contact_person + '"/>';
			}
			if(project_num) {
				html += '<input name="project_num" type="hidden" value="' + project_num + '"/>';
			}
			
			if(cooperate_type) {
				html += '<input name="cooperate_type" type="hidden" value="' + cooperate_type + '"/>';
			}
			if(balance_type) {
				html += '<input name="balance_type" type="hidden" value="' + balance_type + '"/>';
			}
			
			if(sign_company) {
				html += '<input name="sign_company" type="hidden" value="' + sign_company + '"/>';
			}
			if(project_status) {
				html += '<input name="project_status" type="hidden" value="' + project_status + '"/>';
			}
			
			html += '</form>';
			var iframe = document.getElementById('myIFrame');
			iframe.contentWindow.document.open();
			iframe.contentWindow.document.write(html);
			iframe.contentWindow.document.close();
			document.getElementById('myIFrame').contentWindow.document.getElementById('postData_form').submit();
		});
		
		$('#import').click(function() {			//导入表格
			var fileElementId = 'fileupload1';
			if(!document.getElementById(fileElementId).value) {
				alert("请先选择文件");
				return;
			}
			$.ajaxFileUpload({
				url: "{% url 'import_finance_excel'%}",
				secureuri: false,
				fileElementId: fileElementId, //file标签的id
				dataType: 'json', //返回数据的类型
				data: {}, //一同上传的数据
				success: function(data, status) {
					if(data.code == 0) {
						alert("导入成功！ 数量：" + data.num);
					} else {
						alert(data.msg + " 成功数量：" + data.num);
					}
				},
				error: function(data, status, e) {
					alert(e);
				}
			});
			//	hint.innerHTML = '无';
		});

	});
</script>
{% endblock js %} {% block right %}
<div class="Criteria">
	<span>搜索条件</span>
	<div class="Crite-box">
		<form>
			<table width="100%">
				<tr>
					<td>
						<i>立项日期：</i>
						<input id="created_time" type="datetime-local" />
					</td>
					<td>
						<i style="letter-spacing:4.8px;">项目名称：</i>
						<input id="project_name" type="text" />
					</td>
					<td>
						<i style="letter-spacing:4.8px;">商务对接人：</i>
						<input id="contact_person" type="text" />
					</td>
					<td>
						<i style="letter-spacing:4.8px;">项目编号：</i>
						<input id="project_num" type="text" />
					</td>
				</tr>
				<tr>
					<td>
						<i>合作方式：</i>
						<input id="cooperate_type" type="text" />
					</td>
					<td>
						<i style="letter-spacing:2px;">结算方式：</i>
						<input id="balance_type" type="text" />
					</td>
					<td>
						<i style="letter-spacing:4.8px;">签约公司：</i>
						<input id="sign_company" type="text" />
					</td>
					<td>
						<i style="letter-spacing:4.8px;">项目状态</i>
						<select name="selectAge" id="project_status">
							<option value="0">全部</option>
							<option value="1">正在进行</option>
							<option value="2">暂停</option>
							<option value="3">已结束</option>
						</select>
					</td>
				</tr>
				
			</table>
			<div class="Submit-in">
				<input id="single_import" type="button" value="单条导入" />
				<input id="search" type="button" value="搜索" />
				<input id="export" type="button" value="导出" />
			</div>
			<div class="leading-in">
				<input id="fileupload1" name="file" type="file" onchange='hint.innerHTML = this.files[0].name;' />
				<a id="input_clone" class="input-clone">选择文件</a>
				<p class="hint-box">已选择表格：<b id="hint" class="hint">无</b></p>
				<input id="import" type="button" value="表格导入" />
			</div>
		</form>
	</div>
</div>

<div class="Tin-table">
	<div id="pagedata">
	</div>
	<div class="Page-in-admin">
		<div class="page" id="page">
		</div>
	</div>
</div>
{%endblock%} {% block modal %}
<div class="change-project project-box">
	<div class="w570-box">
		<h3 class="popup-title">修改项目数据</h3>
		<button class="none-x"></button>
		<form class="Finnow set-project">
				<input id="project_change_id" type="hidden" />
			<p>
				<span>立项日期：</span>
				<input id="create_time_change" type="text" />
			</p>
			<p>
				<span>项目编号：</span>
				<input id="project_num_change" type="text" />
			</p>
			<p>
				<span>项目名称：</span>
				<input id="project_name_change" type="text" />
			</p>
			<p>
				<span>商务对接人：</span>
				<input id="contact_person_change" type="text" />
			</p>
			<p>
				<span>合作方式：</span>
				<input id="cooperate_type_change" type="text" />
			</p>
			<p>
				<span>结算方式：</span>
				<input id="balance_type_change" type="text" />
			</p>
			<p>
				<span>签约公司：</span>
				<input id="sign_company_change" type="text" />
			</p>
			<p>
				<span>结算详情：</span>
				<input id="balance_change" type="text" />
			</p>
			<p>
				<span>项目状态：</span>
				<select name="selectAge" id="project_status_change">
					<option value="0">全部</option>
					<option value="1">正在进行</option>
					<option value="2">暂停</option>
					<option value="3">已结束</option>
				</select>
			</p>
			
			<div class="Finnow-Sub">
				<input id="change_project_btn" type="submit" value="确认" onclick="return false;"/>
				<input type="button" value="取消" class="none-x-s" />
			</div>
		</form>
	</div>
</div>

<!--删除项目弹窗-->
<div class="delete-project project-box">
	<div class="w570-box">
		<h3>确认删除该条数据？</h3>
		<button class="none-x"></button>
		<form class="Audit-in">
			<input id="project_delete_id" type="hidden" />
			<div class="Finnow-Sub">
				<input id="delete_project_btn" type="submit" value="确认" class="Deny-box" onclick="return false;" />
				<input type="button" value="取消" class="none-x-s" />
			</div>
		</form>
	</div>
</div>
<iframe id="myIFrame" scrolling="yes" src="abount:blank" style="display:none" frameborder=1></iframe>
<!--end-->
{% endblock modal %}